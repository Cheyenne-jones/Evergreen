<!DOCTYPE html>
<html lang='[% ctx.locale.replace('_', '-') %]'>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        [% IF ctx.refresh %]
        <meta http-equiv="refresh" content="[% ctx.refresh %]" />
        [% ELSIF ctx.authtime AND !ctx.is_staff %]
        <meta http-equiv="refresh" content="[% ctx.authtime %]; url=[% ctx.logout_page %]" />
        [% END %]
        <meta name = "viewport" content = "initial-scale = 1.0">
        <link rel="stylesheet" type="text/css" href="[% ctx.media_prefix %]/css/skin/default/opac/semiauto.css" />
        <link rel="stylesheet" type="text/css" href="[% ctx.opac_root %]/css/style.css" />
        <title>[% l('Catalog - [_1]', ctx.page_title) %]</title>
        <link rel="unapi-server" type="application/xml" title="unAPI" href="/opac/extras/unapi" />
        <link type="application/opensearchdescription+xml" rel='search' title="[% l('Evergreen OpenSearch') %]" href="/opac/extras/opensearch/1.1/[% ctx.get_aou(ctx.search_ou).shortname %]/-/osd.xml" />
        [% IF want_dojo %]
        <style type="text/css">
            @import "[% ctx.media_prefix %]/js/dojo/dijit/themes/tundra/tundra.css";
        </style>
        [% END %]
        [% INCLUDE 'opac/parts/goog_analytics.tt2' %]
        [% IF myopac_main_page == "payment_form" AND ctx.get_org_setting(ctx.user.home_ou.id, 'opac.processor.stripe.enabled')%]
        <script type="text/javascript" src="https://js.stripe.com/v2/"></script> <!-- use an ou setting for this url? -->
        <script type="text/javascript">
        // This script is only displayed when logged in, so ctx.user.home_ou is always available
        Stripe.setPublishableKey('[% ctx.get_org_setting(ctx.user.home_ou.id, 'credit.processor.stripe.pubkey') %]');

        function stripe_onsubmit() {
            var form = document.getElementById("stripe_form");
            var button = document.getElementById("payment_submit");

            button.disabled = true;

            Stripe.card.createToken(form, stripe_callback);

            return false;
        }

        function stripe_callback(status, response) {
            var form = document.getElementById("payment_form");
            var button = document.getElementById("payment_submit");
            var stripe_token = document.getElementById("stripe_token");

            if(response.error) {
                alert(response.error.message);
                button.disabled = false;
                return;
            }

            stripe_token.value = response.id; // response.id is the token id, though there are more fields available if needed.
            form.setAttribute("onsubmit","");
            form.submit();
        }
        </script>
        [% END %]

        </head>
    <body[% IF want_dojo; ' class="tundra"'; END %]>
        <h1 class="sr-only">[% l('Catalog') %]</h1>
        [%#Each content page needs (at minimum) an <h2> describing the content%]
        [% content %] 
        <h2 class="sr-only">[% l('Additional Resources') %]</h2>
        [% INCLUDE 'opac/parts/footer.tt2' %]
        [% INCLUDE 'opac/parts/js.tt2' %]
        [%- IF ENV.OILS_CHILIFRESH_ACCOUNT %]
            [%- INCLUDE 'opac/parts/chilifresh.tt2' %]
        [%- END %]
    </body>
</html>
