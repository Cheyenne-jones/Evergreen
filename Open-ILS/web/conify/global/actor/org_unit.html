<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Confiy :: Global :: Actor :: Org Units</title>

		<style type="text/css">
			@import url("/conify/js/dojo/resources/dojo.css");
			@import url("/conify/js/dijit/themes/tundra/tundra.css");
		</style>

		<style>
			html, body
			{
				height: 100%;
				width: 100%;
				margin: 0px 0px 0px 0px;
				padding: 0px 0px 0px 0px;
				overflow: hidden;
			}
		</style>

		<!-- The OpenSRF API writ JS -->
		<script language='javascript' src='/opac/common/js/utils.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/Cookies.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/CGI.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/JSON_v1.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/opensrf.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/opensrf_xhr.js' type='text/javascript'></script>

		<!-- Fieldmapper objects -->
		<script language='javascript' src='/opac/common/js/fmall.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/fmgen.js' type='text/javascript'></script>

		<!-- Dojo goodness -->
		<script type="text/javascript" src="/conify/js/dojo/dojo.js.uncompressed.js" djConfig="parseOnLoad: true"></script>
		<script type="text/javascript" src="/conify/js/dijit/dijit.js.uncompressed.js"></script>

		<script type="text/javascript">
			dojo.require('conify.fieldmapper.addToHash', true);
			dojo.require('dojo.parser');
			dojo.require('dojo.data.ItemFileReadStore');
			dojo.require('dijit.form.TextBox');
			dojo.require('dijit.form.CheckBox');
			dojo.require('dijit.form.FilteringSelect');
			dojo.require('dijit.Tree');
			dojo.require('dijit.layout.ContentPane');
			dojo.require('dijit.layout.TabContainer');
			dojo.require('dijit.layout.SplitContainer');
		</script>

		<script type="text/javascript">
			var cgi = new CGI();
			var cookieManager = new HTTP.Cookies();
			var ses = cookieManager.read('ses') || cgi.param('ses');
			var pCRUD = new OpenSRF.ClientSession('open-ils.permacrud');

			function ouTreeOnClick (m) {
				if (m.event != 'execute') return;

				editor_pane_name.setValue( m.item.name );
				editor_pane_shortname.setValue( m.item.shortname );
				editor_pane_email.setValue( m.item.email );
				editor_pane_phone.setValue( m.item.phone );
				editor_pane_parent_ou.setValue( m.item.parent_ou );
				editor_pane_opac_visible.setChecked( m.item.opac_visible == 't' ? true : false );
			}

		</script>

	</head>

	<body class="tundra" id='pagebody'>

		<div dojoType="dijit.layout.SplitContainer" orientation="horizontal" style="height: 100%">

			<div dojoType="dijit.layout.ContentPane" sizeMin="200" sizeShare="100">
				<script type="dojo/method">

					var ou_list_data = { label : 'displayLabel', identifier : 'id' };
		
					var req = pCRUD.request({
						method : 'open-ils.permacrud.search.aou.atomic',
						timeout : 10,
						params : [ ses, { id : { "!=" : null } }, { order_by : { aou : 'shortname' } } ],
						onerror : function (r) { throw 'Problem fetching org units';},
					});
					req.send();
		
					var _data = req.recv().content();
					var ou_hash_list = [];
					for (var i in _data) ou_hash_list.push( _data[i].toHash() );

					var _find_root = {};
					for (var i in ou_hash_list) {
						_find_root[ou_hash_list[i].id] = ou_hash_list[i]; 
						ou_hash_list[i].displayLabel = ou_hash_list[i].shortname + ' (' + ou_hash_list[i].name + ')';
					}
		
					var item_data = [];
					for (var i in ou_hash_list) {
						var ou = ou_hash_list[i]
						ou.children = [];
		
						for (var j in ou_hash_list) {
							var kid = ou_hash_list[j];
							if (kid.parent_ou == ou.id) {
								ou.children.push( { _reference : kid.id } );
								kid.iskid = true;
								if (_find_root[kid.id]) delete _find_root[kid.id];
							}
						}

						item_data.push( ou );
					}

					for (var j in _find_root) {
						_find_root[j]['top'] = 'true';
					}

					ou_list_data.items = item_data;

					window.ou_list_store = new dojo.data.ItemFileReadStore({ data : ou_list_data });

				</script>
				<div
				  id="dijit_ou_tree"
				  label="Oragnizational Units"
				  query="{'top':'true'}"
				  dojoType="dijit.Tree"
				  store="ou_list_store"
				  minSize="200"
				  jsId="ou_tree"
				>
					<script type="dojo/method">
						tree_execute_sub = dojo.subscribe('dijit_ou_tree',null,ouTreeOnClick);
					</script>
					<script type="dojo/connect" event="destroy">
						dojo.unsubscribe(tree_execute_sub);
					</script>
				</div>
			</div>

			<div id="right_tabpane" dojoType="dijit.layout.TabContainer" sizeMin="200" sizeShare="300">
				<div id="editor_pane" dojoType="dijit.layout.ContentPane" title="Main Settings">
					<table class="tundra">
						<tr>
							<th>Parent</th>
							<td>
								<div
								  id="editor_pane_parent_ou"
								  dojoType="dijit.form.FilteringSelect"
								  jsId="editor_pane_parent_ou"
								  store="ou_list_store"
								  searchAttr="displayLabel"
								  ignoreCase="true"
								/>
							</td>
							<th>OPAC Visible</th>
							<td>
								<input
								  id="editor_pane_opac_visible"
								  jsId="editor_pane_opac_visible"
								  type="checkbox"
								  dojoType="dijit.form.CheckBox"
								  value='t'
								/>
							</td>
						</tr>
						<tr>
							<th>Library Name</th>
							<td>
								<span id="editor_pane_name" dojoType="dijit.form.TextBox" jsId="editor_pane_name"/>
							</td>
							<th>Library Policy Code</th>
							<td>
								<span id="editor_pane_shortname" dojoType="dijit.form.TextBox" jsId="editor_pane_shortname"/>
							</td>
						</tr>
						<tr>
							<th>Main Email Address</th>
							<td>
								<span id="editor_pane_email" dojoType="dijit.form.TextBox" jsId="editor_pane_email"/>
							</td>
							<th>Main Phone Number</th>
							<td>
								<span id="editor_pane_phone" dojoType="dijit.form.TextBox" jsId="editor_pane_phone"/>
							</td>
						</tr>
					</table>
				</div>
			</div>

		</div>

	</body>
</html>
