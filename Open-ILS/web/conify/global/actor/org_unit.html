<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Confiy :: Global :: Actor :: Org Units</title>

		<style type="text/css">
			@import url("/conify/js/dojo/resources/dojo.css");
			@import url("/conify/js/dijit/themes/tundra/tundra.css");
			@import url("/conify/js/dojox/widget/Toaster/Toaster.css");
		</style>

		<style>
			html, body
			{
				height: 100%;
				width: 100%;
				margin: 0px 0px 0px 0px;
				padding: 0px 0px 0px 0px;
				overflow: hidden;
			}
		</style>

		<!-- The OpenSRF API writ JS -->
		<script language='javascript' src='/opac/common/js/utils.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/Cookies.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/CGI.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/JSON_v1.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/opensrf.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/opensrf_xhr.js' type='text/javascript'></script>

		<!-- Fieldmapper objects -->
		<script language='javascript' src='/opac/common/js/fmall.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/fmgen.js' type='text/javascript'></script>
		<script language='javascript' src='/opac/common/js/OrgTree.js' type='text/javascript'></script>

		<!-- Dojo goodness -->
		<script type="text/javascript" src="/conify/js/dojo/dojo.js.uncompressed.js" djConfig="parseOnLoad: true"></script>
		<script type="text/javascript" src="/conify/js/dijit/dijit.js.uncompressed.js"></script>

		<script type="text/javascript">
			dojo.require('conify.fieldmapper.addToHash', true);
			dojo.require('conify.fieldmapper.addFromHash', true);
			dojo.require('conify.fieldmapper.addToStoreData', true);
			dojo.require('conify.fieldmapper.addFromStoreItem', true);
			dojo.require('dojo.parser');
			dojo.require('dojo.data.ItemFileWriteStore');
			dojo.require('dijit.form.TextBox');
			dojo.require('dijit.form.ValidationTextBox');
			dojo.require('dijit.form.CheckBox');
			dojo.require('dijit.form.FilteringSelect');
			dojo.require('dijit.Tree');
			dojo.require('dijit.layout.ContentPane');
			dojo.require('dijit.layout.TabContainer');
			dojo.require('dijit.layout.LayoutContainer');
			dojo.require('dijit.layout.SplitContainer');
			dojo.require('dojox.widget.Toaster');
			dojo.require('dojox.fx');
		</script>

		<script type="text/javascript">
			// some handy globals

			var cgi = new CGI();
			var cookieManager = new HTTP.Cookies();
			var ses = cookieManager.read('ses') || cgi.param('ses');
			var pCRUD = new OpenSRF.ClientSession('open-ils.permacrud');

			var current_ou;
			var virgin_ou_id = -1;

			var ou_type_store = new dojo.data.ItemFileWriteStore({ data : aout.toStoreData( globalOrgTypes ) });

			var highlighter = {};
		</script>

	</head>

	<body class="tundra" id='pagebody'>

		<div dojoType="dijit.layout.SplitContainer" orientation="horizontal" style="height: 100%">

			<div dojoType="dijit.layout.ContentPane" sizeMin="200" sizeShare="100">
				<script type="dojo/method">

					var ou_list_data = { label : 'shortname', identifier : 'id' };
		
					pCRUD.request({
						method : 'open-ils.permacrud.search.aou.atomic',
						timeout : 10,
						params : [ ses, { id : { "!=" : null } }, { order_by : { aou : 'shortname' } } ],
						onerror : function (r) { throw 'Problem fetching org units';},
						oncomplete : function (r) { window.ou_list_store = new dojo.data.ItemFileWriteStore({ data : aou.toStoreData( r.recv().content() ) }); }
					}).send();
		

				</script>
				<div
				  id="dijit_ou_tree"
				  label="Oragnizational Units"
				  query="{'_top':'true'}"
				  dojoType="dijit.Tree"
				  store="ou_list_store"
				  minSize="200"
				  jsId="ou_tree"
				>

					<script type="dojo/method" event="onClick" args="item,node">

						highlighter.editor_pane.green.play();

						new_kid_button.disabled = false;
						save_ou_button.disabled = false;
						delete_ou_button.disabled = false;

						current_ou = item;

						var main_settings_fields = [ 'name', 'shortname', 'email', 'phone', 'ou_type' ];
						for ( var i in main_settings_fields ) {
							var field = main_settings_fields[i];
							var value = this.store.getValue( current_ou, field );

							if (!value) {
								window["editor_pane_" + field].setValue( '' ); // unset the value
								window["editor_pane_" + field].setDisplayedValue( '' ); // unset the value
							} else window["editor_pane_" + field].setValue( value );
						}

						if ( this.store.getValue( current_ou, '_trueRoot' ) == 'true' ) {
							editor_pane_parent_ou.disabled = true;
							editor_pane_parent_ou.setValue(null);
							editor_pane_parent_ou.setDisplayedValue('');
							editor_pane_parent_ou.validate(false);
						} else {
							editor_pane_parent_ou.disabled = false;
							editor_pane_parent_ou.validate(true);
							editor_pane_parent_ou.setValue( this.store.getValue( current_ou, 'parent_ou' ) );
						}

						editor_pane_opac_visible.setChecked( this.store.getValue( current_ou, 'opac_visible' ) == 't' ? true : false );

					</script>

					<script type="dojo/method" event="getLabel" args="item,pI">
						return this.store.getValue(item,'shortname') + ' : ' + this.store.getValue(item,'name');
					</script>

				</div>
			</div>

			<div id="right_tabpane" dojoType="dijit.layout.TabContainer" sizeMin="200" sizeShare="300">

				<div id="editor_pane" dojoType="dijit.layout.ContentPane" title="Main Settings">
					<script type="dojo/method">
						highlighter.editor_pane = {};
						highlighter.editor_pane.green = dojox.fx.highlight( { color : '#B4FFB4', node : 'editor_pane', duration : 500 } );
						highlighter.editor_pane.red = dojox.fx.highlight( { color : '#FF2018', node : 'editor_pane', duration : 500 } );
					</script>
					<table class="tundra" style="margin:10px;">
						<tr>
							<th>Org Unit Name</th>
							<td>
								<span id="editor_pane_name" dojoType="dijit.form.ValidationTextBox" jsId="editor_pane_name" regExp=".+">
									<script type="dojo/connect" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "name", this.getValue() );
									</script>
								</span>
							</td>
						</tr>
						<tr>
							<th>Org Unit Policy Code</th>
							<td>
								<span id="editor_pane_shortname" dojoType="dijit.form.ValidationTextBox" jsId="editor_pane_shortname" uppercase="true" regExp=".+">
									<script type="dojo/connect" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "shortname", this.getValue() );
									</script>
								</span>
							</td>
						</tr>
						<tr>
							<th>Main Email Address</th>
							<td>
								<span id="editor_pane_email" dojoType="dijit.form.ValidationTextBox" jsId="editor_pane_email" regExp="^\w+\@\w+(?:\.\w+)+$">
									<script type="dojo/connect" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "email", this.getValue() );
									</script>
								</span>
							</td>
						</tr>
						<tr>
							<th>Main Phone Number</th>
							<td>
								<span id="editor_pane_phone" dojoType="dijit.form.ValidationTextBox" jsId="editor_pane_phone" regExp="^(?:(?:\d{1}[ -\.])?\(?\d{3}\)?[ -\.]{1})?\d{3}[ -\.]{1}\d{4}(| \S+.*)$">
									<script type="dojo/connect" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "phone", this.getValue() );
									</script>
								</span>
							</td>
						</tr>
						<tr>
							<th>Org Unit Type</th>
							<td>
								<div
								  id="editor_pane_ou_type"
								  dojoType="dijit.form.FilteringSelect"
								  jsId="editor_pane_ou_type"
								  store="ou_type_store"
								  searchAttr="name"
								  ignoreCase="true"
								>
									<script type="dojo/method" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "ou_type", this.getValue() );
									</script>
								</div>
							</td>
						</tr>
						<tr>
							<th>Parent Org Unit</th>
							<td>
								<div
								  id="editor_pane_parent_ou"
								  dojoType="dijit.form.FilteringSelect"
								  jsId="editor_pane_parent_ou"
								  store="ou_list_store"
								  searchAttr="shortname"
								  ignoreCase="true"
								>
									<script type="dojo/method" event="onChange">
										if (current_ou) this.store.setValue( current_ou, "parent_ou", this.getValue() );
									</script>
								</div>
							</td>
						</tr>
						<tr>
							<th>OPAC Visible</th>
							<td>
								<input
								  id="editor_pane_opac_visible"
								  jsId="editor_pane_opac_visible"
								  type="checkbox"
								  dojoType="dijit.form.CheckBox"
								  value='t'
								>
									<script type="dojo/connect" event="onChange">
										if (current_ou) ou_list_store.setValue( current_ou, "opac_visible", this.isChecked() ? "t":"f" );
									</script>
								</input>
							</td>
						</tr>
					</table>

					<div dojoType="dijit.layout.ContentPane" orientation="horizontal" style="margin-bottom: 20px;">

						<button jsId="save_ou_button" dojoType="dijit.form.Button" label="Save">
							<script type="dojo/connect" event="startup">
								this.disabled = true;
							</script>
							<script type="dojo/connect" event="onClick">

								var modified_ou = new aou().fromStoreItem( current_ou );
								modified_ou.ischanged( 1 );

								pCRUD.request({
									method : 'open-ils.permacrud.update.aou',
									timeout : 10,
									params : [ ses, modified_ou ],
									onerror : function (r) {
										highlighter.editor_pane.red.play();
										throw 'Problem saving data for ' + ou_list_store.getValue( current_ou, 'name' );
									},
									oncomplete : function (r) {
										var res = r.recv();
										if ( res && res.content() ) {
											highlighter.editor_pane.green.play();
										} else {
											highlighter.editor_pane.red.play();
											throw 'Problem saving data for ' + ou_list_store.getValue( current_ou, 'name' );
										}
									},
								}).send();

							</script>
						</button>

						<button jsId="delete_ou_button" dojoType="dijit.form.Button" label="Delete">
							<script type="dojo/connect" event="startup">
								this.disabled = true;
							</script>
							<script type="dojo/connect" event="onClick">

								if ( current_ou.children ) {
									var kids = current_ou.children;
									if (!dojo.isArray(kids)) kids = [kids];

									var existing_kids = dojo.filter(
										kids,
										function(kid){ return kid.isdeleted[0] != 1 }
									);
									if ( existing_kids.length > 0) {
										highlighter.editor_pane.red.play();
										alert(existing_kids.length + ' kids still exist');
										return;
									}
								}

								if ( confirm('Are you sure you want to delete ' + current_ou.name + '?')) {
									ou_list_store.setValue( current_ou, 'isdeleted', 1 );

									var modified_ou = new aou().fromStoreItem( current_ou );
									modified_ou.isdeleted( 1 );

									pCRUD.request({
										method : 'open-ils.permacrud.delete.aou',
										timeout : 10,
										params : [ ses, modified_ou ],
										onerror : function (r) {
											highlighter.editor_pane.red.play();
											throw 'Problem deleting ' + ou_list_store.getValue( current_ou, 'name' );
										},
										oncomplete : function (r) {
											var res = r.recv();
											if ( res && res.content() ) {

												ou_list_store.fetch({
													query : { id : ou_list_store.getValue( current_ou, 'id' ) },
													queryOptions : { deep : true },
													onItem : function (item, req) { try { this.deleteItem( item ); } catch (e) { /* meh */ } },
													scope : ou_list_store
												});

												current_ou = null;

												new_kid_button.disabled = true;
												save_ou_button.disabled = true;
												delete_ou_button.disabled = true;
		
												var main_settings_fields = [ 'name', 'shortname', 'email', 'phone', 'ou_type', 'parent_ou' ];
												for ( var i in main_settings_fields ) {
													var field = main_settings_fields[i];
													window["editor_pane_" + field].setValue( '' ); // unset the value
													window["editor_pane_" + field].setDisplayedValue( '' ); // unset the value
												}
		
												highlighter.editor_pane.green.play();
											} else {
												highlighter.editor_pane.red.play();
												throw 'Problem deleting ' + ou_list_store.getValue( current_ou, 'name' );
											}
										},
									}).send();

								}

							</script>
						</button>

					</div>

					<button jsId="new_kid_button" dojoType="dijit.form.Button" label="New Child">
						<script type="dojo/connect" event="startup">
							this.disabled = true;
						</script>
						<script type="dojo/connect" event="onClick">

							var new_fm_obj = new aou().fromHash({
								isnew			: 1,
								name			: 'New Branch',
								opac_visible	: 'f',
								shortname		: ou_list_store.getValue( current_ou, 'shortname' ) + '-NEW' + virgin_ou_id--,
								parent_ou		: ou_list_store.getValue( current_ou, 'id' ),
								ou_type			: ou_list_store.getValue( current_ou, 'ou_type' )
							});

							var new_obj;

							pCRUD.request({
								method : 'open-ils.permacrud.create.aou',
								timeout : 10,
								params : [ ses, new_fm_obj ],
								onerror : function (r) {
									highlighter.editor_pane.red.play();
									throw 'Problem creating child Org Unit';
								},
								oncomplete : function (r) {
									var res = r.recv();
									if ( res && res.content() ) {
										ou_list_store.newItem(
											res.content().toHash(),
											{ parent : current_ou, attribute : 'children' }
										);
									} else {
										highlighter.editor_pane.red.play();
										throw 'Problem creating child Org Unit';
									}
								},
							}).send();

							highlighter.editor_pane.green.play();

						</script>
					</button>

				</div>

				<div id="hoo_pane" dojoType="dijit.layout.ContentPane" title="Hours of Operation">
				</div>

			</div>

		</div>

	</body>
</html>
