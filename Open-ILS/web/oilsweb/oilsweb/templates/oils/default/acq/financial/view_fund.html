# -*- coding: utf-8 -*-
<%inherit file='../base.html'/>
<%def name="page_title()">${_('View Fund')}</%def>
<%def name="block_content()">

<script>
    dojo.require("dijit.Dialog");
    dojo.require('dijit.layout.TabContainer');
    dojo.require('dijit.layout.ContentPane');
    dojo.require('openils.acq.Fund');
    dojo.require('openils.Event');
    dojo.require('fieldmapper.Fieldmapper');
    dojo.require('openils.User');

    var fundID = ${c.oils.acq.fund_id};
    var fund = null;

    function getSummaryInfo(rowIndex) {
        switch(this.index) {
            case 4: return new String(fund.summary().combined_balance);
            case 5: return new String(fund.summary().allocation_total);
            case 6: return new String(fund.summary().spent_balance);
            case 7: return new String(fund.summary().debit_total);
            case 8: return new String(fund.summary().spent_total);
            case 9: return new String(fund.summary().encumberance_total);
        }
    }

    function getOrgInfo(rowIndex) {
        data = fundGrid.model.getRow(rowIndex);
        if(!data) return;
        return fieldmapper.aou.findOrgUnit(data.org).shortname();
    }

    var fsCache = {};
    function getFundingSource(rowIndex) {
        data = fundAllocationGrid.model.getRow(rowIndex);
        if(!data) return;
        var fsId = data.funding_source;
        if(!fsCache[fsId]) {
            fsCache[fsId] = fieldmapper.standardRequest(
                ['open-ils.acq', 'open-ils.acq.funding_source.retrieve'],
                [openils.User.authtoken, fsId]
            );
        }
        var name = fsCache[fsId].name();
        return '<a href="${c.oils.acq.prefix.value}/funding_source/view/'+fsId+'">'+name+'</a>';
    }

    function loadFundGrid() {
        var store = new dojo.data.ItemFileReadStore({data:acqf.toStoreData([fund])});
        var model = new dojox.grid.data.DojoData(
            null, store, {rowsPerPage: 20, clientSort: true, query:{id:'*'}});
        fundGrid.setModel(model);
        fundGrid.update();
    }

    function loadAllocationGrid() {
        if(fundAllocationGrid.isLoaded) return;
        var store = new dojo.data.ItemFileReadStore({data:acqfa.toStoreData(fund.allocations())});
        var model = new dojox.grid.data.DojoData(
            null, store, {rowsPerPage: 20, clientSort: true, query:{id:'*'}});
        fundAllocationGrid.setModel(model);
        fundAllocationGrid.update();
        fundAllocationGrid.isLoaded = true;
    }

    function loadDebitGrid() {
        if(fundDebitGrid.isLoaded) return;
        var store = new dojo.data.ItemFileReadStore({data:acqfa.toStoreData(fund.debits())});
        var model = new dojox.grid.data.DojoData(
            null, store, {rowsPerPage: 20, clientSort: true, query:{id:'*'}});
        fundDebitGrid.setModel(model);
        fundDebitGrid.update();
        fundDebitGrid.isLoaded = true;
    }

    function fetchFund() {
        fieldmapper.standardRequest(
            ['open-ils.acq', 'open-ils.acq.fund.retrieve'],
            {   async: true,
                params: [
                    openils.User.authtoken, fundID, 
                    {flesh_summary:1, flesh_allocations:1, flesh_debits:1} 
                    /* TODO grab allocations and debits only on as-needed basis */
                ],
                oncomplete: function(r) {
                    fund = r.recv().content();
                    loadFundGrid(fund);
                }
            }
        );
    }

    dojo.addOnLoad(fetchFund);
</script>
    
<div id='oils-acq-list-header' class='container'>
    <div id='oils-acq-list-header-label'>${_('Fund Details')}</div>
</div>

<style>
    .oils-acq-detail-content-pane {height:500px;width:100%}
</style>

<div dojoType="dijit.layout.ContentPane" layoutAlign="top">
    <div dojoType="dijit.layout.TabContainer">
        <div dojoType="dijit.layout.ContentPane" 
                class='oils-acq-detail-content-pane' title="${_('Summary')}" selected='true'>
            <script>
                /** Define the columns for the fund grid ----- */
                var fundGridLayout = [{
                    cells : [[
                        {name: '${_("ID")}', field: 'id'},
                        {name: '${_("Name")}', field: "name", width:'auto'}, 
                        {name: '${_("Currency Type")}', field: "currency_type"},
                        {name: '${_("Owner")}', get:getOrgInfo}, 
                        /*
                        {name: '${_("Balance (Total - (Spent + Encumberances))")}', get:getSummaryInfo},
                        {name: '${_("Amount Allocated to this Fund")}', get:getSummaryInfo},
                        {name: '${_("Spent Balance (Total - Spent)")}', get:getSummaryInfo},
                        {name: '${_("Total Debits (Spent + Encumbered)")}', get:getSummaryInfo},
                        */
                        {name: '${_("Balance")}', get:getSummaryInfo},
                        {name: '${_("Total Allocated")}', get:getSummaryInfo},
                        {name: '${_("Spent Balance")}', get:getSummaryInfo},
                        {name: '${_("Total Debits")}', get:getSummaryInfo},
                        {name: '${_("Total Spent")}', get:getSummaryInfo},
                        {name: '${_("Total Encumbered")}', get:getSummaryInfo}
                    ]]
                }];
            </script>
            <div jsId='fundGrid' dojoType="dojox.Grid" structure='fundGridLayout'> </div>
        </div>
        <div dojoType="dijit.layout.ContentPane" class='oils-acq-detail-content-pane' title="${_('Allocations')}">
            <script type='dojo/connect' event='onShow'>loadAllocationGrid();</script>
            <script>
                /** Define the columns for the funding source allocations grid ----- */
                var fundAllocationGridLayout = [{
                    cells : [[
                        {name: '${_("ID")}', field: 'id'},
                        {name: '${_("Funding Source")}', field: "fund", get:getFundingSource}, 
                        {name: '${_("Amount")}', field: "amount"}, 
                        {name: '${_("Percent")}', field: "percent"}, 
                        {name: '${_("Allocated By")}', field: "allocator"}, 
                        {name: '${_("Note")}', field: "note", width:'auto'}, 
                    ]]
                }];
            </script>
            <div jsId='fundAllocationGrid' dojoType="dojox.Grid" structure='fundAllocationGridLayout'> </div>
        </div>
        <div dojoType="dijit.layout.ContentPane" class='oils-acq-detail-content-pane' title="${_('Debits')}">
            <script type='dojo/connect' event='onShow'>loadDebitGrid();</script>
            <script>
                /** Define the columns for the funding source credits grid ----- */
                var fundDebitGridLayout = [{
                    cells : [[
                        {name: '${_("ID")}', field: 'id'},
                        {name: '${_("Origin Amount")}', field: "origin_amount"}, 
                        {name: '${_("Origin Currency Type")}', field: "origin_currency_type"}, 
                        {name: '${_("Amount")}', field: "amount"}, 
                        {name: '${_("Encumberance")}', field: "encumberance"}, 
                        {name: '${_("Debit Type")}', field: "debit_type"}, 
                        {name: '${_("Transfer Destination")}', field: "xfer_destination"}, 
                    ]]
                }];
            </script>
            <div jsId='fundDebitGrid' dojoType="dojox.Grid" structure='fundDebitGridLayout'> </div>
        </div>
    </div>
</div>
</%def>
