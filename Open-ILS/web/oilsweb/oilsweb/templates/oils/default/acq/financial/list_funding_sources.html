# -*- coding: utf-8 -*-
<%inherit file='../base.html'/>
<%namespace file='../../common/widgets.html' name='widget'/>
<%def name="page_title()">${_('Funding Sources')}</%def>
<%def name="block_content()">

<div id='oils-acq-list-header' class='container'>
    <div id='oils-acq-list-header-label'>${_('Funding Sources')}</div>
</div>

<script type="text/javascript">
    dojo.require("dijit.Dialog");
    dojo.require("dijit.form.FilteringSelect");
    dojo.require('openils.acq.FundingSource');
    dojo.require('openils.Event');
    dojo.require('openils.acq.CurrencyType');

    function createFS(fields) {
        /** Creates a new funding source */
        var tree = dijit.byId('oils-acq-funding_source-owner-tree');
        fields.owner = tree.selected;
        openils.acq.FundingSource.create(
            fields, 
            function(fsId) {
                var evt = openils.Event.parse(fsId);
                if(evt) {
                    alert(evt); /* XXX */
                    return;
                } else {
                    location.href =  /* go to the details page for this fs */
                        '${c.oils.acq.prefix.value}/funding_source/view/'+fsId;
                }
            }
        );
    }
</script>

<div class='oils-acq-actions-div'>
    <div dojoType="dijit.form.DropDownButton">
        <span>${('New Funding Source')}</span>
        <div dojoType="dijit.TooltipDialog" execute="createFS(arguments[0]);">
            <table class='dijitTooltipTable'>
                <tr>
                    <td><label for="name">${_('Name:')} </label></td>
                    <td><input dojoType="dijit.form.TextBox" name="name"></td>
                </tr>
                <tr>
                    <td><label for="currency_type">${_('Currency Type:')}</label></td>
                    <td>
                        <input jsId='fsCurrencySelector' name="currency_type" 
                            dojoType="dijit.form.FilteringSelect" searchAttr='code'>
                        </input>
                    </td>
                </tr>
                <tr>
                    <td><label for="owner">${_('Owning Location:')} </label></td>
                    <td>
                        <div id='oils-acq-funding_source-owner-tree'> </div>
                    </td>
                </tr>
                <tr>
                    <td colspan='2' align='center'>
                        <button dojoType=dijit.form.Button type="submit">${_('Create')}</button>
                    </td>
                </tr>
            </table>
        </div>
    </div> 

    <button dojoType="dijit.form.Button" 
            onclick="openils.acq.FundingSource.deleteFromGrid(
                fundingSourceListGrid, function(){location.href = location.href})">
        ${_('Delete Selected')}
    </button>
</div>

<!-- The actual grid lives here -->
<div id="oils-acq-funding-source-list-grid" jsId='fundingSourceListGrid' dojoType="dojox.Grid"></div>

<script>

    function loadCurrencyTypes() {
        openils.acq.CurrencyType.fetchAll(
            function(ctypes) {
                fsCurrencySelector.store = 
                    new dojo.data.ItemFileReadStore(
                        {data:acqct.toStoreData(ctypes, 'code', {identifier:'code'})}
                    );
                fsCurrencySelector.labelAttr = 'code';
                fsCurrencySelector.setValue(ctypes[0].code()); /* XXX get from setting */
            }
        );
    }

    function loadPermOrgs() {
        var ses = new OpenSRF.ClientSession('open-ils.actor');
        var req = ses.request(
            'open-ils.actor.user.work_perm.org_unit_list',
            openils.User.authtoken, 'ADMIN_FUNDING_SOURCE');

        req.oncomplete = function(r) {
            var orgList = r.recv().content();
            var store = new dojo.data.ItemFileReadStore({data:aou.toStoreData(orgList)});
            var model = new dijit.tree.ForestStoreModel({
                store: store,
                query: {_top:'true'},
                childrenAttrs: ["children"],
                rootLabel : '${_("Location")}'
            });

            var tree = new dijit.Tree(
                {model : model},
                dojo.byId('oils-acq-funding_source-owner-tree')
            );
            dojo.connect(tree, 'onClick', function(item) {tree.selected = item.id[0]});
            tree.startup()
        }
        req.send();
    }

    function loadFSGrid() {
        openils.User.getBySession();
        loadCurrencyTypes();
        loadPermOrgs();

        function getOrgInfo(rowIndex) {
            data = fundingSourceListGrid.model.getRow(rowIndex);
            if(!data) return;
            return fieldmapper.aou.findOrgUnit(data.owner).shortname();
        }

        function getBalanceInfo(rowIndex) {
            data = fundingSourceListGrid.model.getRow(rowIndex);
            if(!data) return;
            return new String(openils.acq.FundingSource.cache[data.id].summary().balance);
        }

        function getName(rowIndex) {
            data = fundingSourceListGrid.model.getRow(rowIndex);
            if(!data) return;
            return '<a href="${c.oils.acq.prefix.value}/funding_source/view/'+data.id+'">'+data.name+'</a>';
        }
    
        var gridStructure = [{
            cells : [[
                {name: '${_("ID")}', field: 'id'},
                {name: '${_("Name")}', field: "name", width:'auto', get:getName}, 
                {name: '${_("Owner")}', field: "owner", width:'auto', get:getOrgInfo}, 
                {name: '${_("Currency Type")}', field: "currency_type"},
                {name: '${_("Balance")}', field: "balance", get:getBalanceInfo}
            ]]
        }];

        openils.acq.FundingSource.createStore(
            function(storeData) {
                var store = new dojo.data.ItemFileWriteStore({data:storeData});
                var model = new dojox.grid.data.DojoData(null, store, 
                    {rowsPerPage: 20, clientSort: true, query:{id:'*'}});
                fundingSourceListGrid.setStructure(gridStructure);
                fundingSourceListGrid.setModel(model);
                fundingSourceListGrid.update();
            }
        );
    }

    dojo.addOnLoad(loadFSGrid);
</script>

</%def>
