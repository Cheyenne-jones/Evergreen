# -*- coding: utf-8 -*-
<!-- 
 vim:ts=4:sw=4:et:ft=mako: 
-->
<%inherit file='../base.html'/>
<%namespace file='../../common/widgets.html' name='widget' />
<%namespace file='picklist_summary.html' name='picklist' />

<%def name="block_js()">
    ${parent.block_js()}

    <script type="text/javascript">
        dojo.require("dijit.layout.SplitContainer")
	dojo.require('openils.acq.Picklist');
	// For decoding fund IDs into names
	dojo.require("openils.acq.Fund");
	// For decoding Library IDs into names
	dojo.require("fieldmapper.OrgUtils");
    </script>
    <script type='text/javascript'>
	function getJUBTitle(rowIndex) {
	    var data = pickListGrid.model.getRow(rowIndex);
	    if (!data) return '';
	    return openils.acq.Picklist.find_attr(data.id, "title", "lineitem_marc_attr_definition")
	}
	function getJUBPrice(rowIndex) {
	    var data = pickListGrid.model.getRow(rowIndex);
	    if (!data) return;
	    return openils.acq.Picklist.find_attr(data.id, "price", "lineitem_marc_attr_definition")
	}
	function getLIDFundName(rowIndex) {
	    var data = lineItemGrid.model.getRow(rowIndex);
	    if (!data || !data.fund) return;
	    try {
		return openils.acq.Fund.retrieve(data.fund).name();
	    } catch (evt) {
		return data.fund;
	    }
	}
	function getLIDLibName(rowIndex) {
	    var data = lineItemGrid.model.getRow(rowIndex);
	    if (!data || !data.owning_lib) return;
	    try {
		return fieldmapper.aou.findOrgUnit(data.owning_lib, true).name();
	    } catch (evt) {
		return data.owning_lib;
	    }
	}
    </script>
</%def>
<%def name="page_title()">${_('Picklist')}</%def>

<%def name="block_content()">
<div dojoType="dijit.layout.LayoutContainer" style="height:100%">
    <div dojoType="dijit.layout.ContentPane" layoutAlign="top">
	${picklist.summary(c.oils.acq.picklist.value)}
    </div>
    <div dojoType="dijit.layout.SplitContainer"
	 orientation="vertical" sizerWidth="5"
	 activeSizing="1" layoutAlign="client">
	<div id="oils-acq.picklist-container"
	     dojoType="dijit.layout.ContentPane" sizeMin="20" sizeShare="20">
	    <div jsid='pickListGrid' dojoType='dojox.Grid'
		 id="oils-acq-picklist-grid"> </div>
	    <script type="text/javascript" src="/js/dojo/openils/acq/Lineitems.js"></script>
	    <script type="text/javascript" src="/js/dojo/openils/widget/FundSelector.js"></script>
	    <script type="text/javascript">
                dojo.require("openils.acq.Picklist");
 		dojo.require("openils.acq.Lineitems");
//		dojo.require("openils.widget.FundSelector");
		dojo.require('dojo.data.ItemFileReadStore');

		var picklistLayout = [{
		    cells: [[
			{name: "ID", field: 'id'},
			{name: "Title", width: "50%", get:getJUBTitle},
			{name: "Price", get:getJUBPrice},
			{name: "Vendor", field: 'provider'},
			{name: "# of Copies", field: 'item_count'}
		    ]]
		}];

		var lineitemLayout = [{ cells: [[
		    {name:"ID", field:"id"},
		    {name:"Fund", field:"fund",
		     editor: openils.widget.FundSelector,
		     get:getLIDFundName},
		    {name:"Location", get:getLIDLibName} ]] }];

		openils.acq.Picklist.createStore(${c.oils.acq.picklist.value.id()},
		    function(storeData) {
		        var store = new dojo.data.ItemFileReadStore({data:storeData});
		        var model = new dojox.grid.data.DojoData(null, store,
		                         {rowsPerPage:20, clientSort:true,
                                          query:{id:'*'}});
		        pickListGrid.setStructure(picklistLayout);
		        pickListGrid.setModel(model);

			pickListGrid.onRowClick = function(evt) {
			    openils.acq.Lineitems.loadGrid(lineItemGrid,
							   model.getRow(evt.rowIndex).id,
							   lineitemLayout);
			};

		        pickListGrid.update();
                    });
	    </script>
	</div>
	<div dojoType="dijit.layout.ContentPane" sizeMin="20"
	     sizeShare="80">
	    <div jsid="lineItemGrid" dojoType="dojox.Grid" id="oils-acq-picklist-details-grid">
		<!-- Copy order details go here -->
	    </div>
	</div>
    </div>
</div>
</%def>
