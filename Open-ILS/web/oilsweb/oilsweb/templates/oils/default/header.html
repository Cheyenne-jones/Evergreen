# -*- coding: utf-8 -*-
<div id='oils-base-header-content-div'>
    <% 
        import pylons
        if 'oils_demo_user' in pylons.config:
            auto_login = True
        else:
            auto_login = False
    %>
    % if auto_login:
        <span id='oils-base-header-auto-login'>${_('Auto-login is enabled')}</span>|
        <script src='/opac/common/js//Cookies.js'> </script>
        <script>
            dojo.require('dojo.cookie');
            dojo.require('openils.User');
            dojo.require('openils.Event');
            dojo.require('openils.CGI');

            var authtoken = dojo.cookie('ses') || new openils.CGI().param('ses');
            var username = '${pylons.config.get("oils_demo_user")}';
            var password = '${pylons.config.get("oils_demo_password")}';
            var user;

            function dologin() {
                openils.User.authtoken = null;
                user = new openils.User();
                user.login({
                    login_type:'staff', 
                    username:username, 
                    passwd:password, 
                    login:true
                });
                user.getBySession();
                dojo.cookie('ses', user.authtoken);
            }

            if(authtoken) {
                user = new openils.User({authtoken:authtoken});
                var res = user.getBySession();
                if(openils.Event.parse(res)) 
                    dologin();
                else /* in case we got the ses from the URL */
                    dojo.cookie('ses', user.authtoken);
            } else {
                dologin();
            }
        </script>
        <span id='oils-base-header-user-info'> </span>
        <script>
            dojo.byId('oils-base-header-user-info').appendChild(
                document.createTextNode(user.user.usrname()));
        </script>
    % endif
</div>
